# AS Test Backend (as-test-2)

Comprehensive README for the backend API in this workspace. Covers project purpose, structure, setup, Prisma/database, testing, coverage, and development tips.

---

**Project Overview**

- **Purpose:** A TypeScript/Node backend exposing authentication and transactions routes with Prisma for database access and Jest for tests/coverage.
- **Primary languages / tooling:** TypeScript, Node.js, Prisma, Jest.

---

**Quick Start**

1. Install dependencies:

```bash
npm install
# or
yarn
```

2. Generate Prisma client and apply migrations (adjust to your workflow):

```bash
npx prisma generate
# for development (interactive):
npx prisma migrate dev
# for deployed environments:
npx prisma migrate deploy
```

3. Run the app (check `package.json` for script names):

```bash
npm run dev
# or
npm start
```

4. Run tests and view coverage:

```bash
npm test
# coverage report (if configured):
npm run coverage
```

Note: exact script names may differ; consult `package.json`.

---

**Environment / Configuration**

Typical environment variables this project expects (add to `.env` or your environment):

- `DATABASE_URL` — connection string for your database used by Prisma.
- `PORT` — server port (defaults often to `3000` or `8000`).
- `SESSION_SECRET` — secret for session signing (if sessions are used in `src/middleware/session.ts`).
- Rate-limit / Redis / other service URLs if the project uses them.

Search and adjust these values in `src` if needed.

---

**Database & Prisma**

- Prisma schema is at [prisma/schema.prisma](prisma/schema.prisma).
- Generated Prisma client and artifacts are under [generated/prisma](generated/prisma).
- Migrations folder: [prisma/migrations](prisma/migrations) (contains migration SQLs and metadata).

Typical Prisma commands:

- `npx prisma generate` — create the generated client.
- `npx prisma migrate dev` — run migrations locally and update DB.
- `npx prisma migrate deploy` — apply migrations in CI/production.

If you modify `prisma/schema.prisma`, re-run `npx prisma generate`.

---

**Scripts & Testing**

- Tests are implemented with Jest. Tests and setup are in `src/tests`:
  - [src/tests/setup/setup.ts](src/tests/setup/setup.ts) — test setup utilities.
  - [src/tests/setup/test-app.ts](src/tests/setup/test-app.ts) — app boot for tests.
  - [src/tests/test-suites](src/tests/test-suites) — test suites (isolation, transactions, user tests).
  - [src/tests/mocks](src/tests/mocks) — mocks for auth and Prisma.

- Coverage artifacts (generated by test runs) are in the `coverage/` directory — open `coverage/lcov-report/index.html` in a browser to view a formatted report.

Suggested commands:

```bash
npm test
# then to open coverage report locally:
# open coverage/lcov-report/index.html in your browser
```

---

**Project Structure (key files and purpose)**

- [src/index.ts](src/index.ts) — application entrypoint; sets up server, middleware, and routes.
- [lib/prisma.ts](lib/prisma.ts) — Prisma client wrapper for DB access.
- [src/lib/auth.ts](src/lib/auth.ts) — shared auth helpers used by routes/services.

- Routes:
  - [src/routes/auth.routes.ts](src/routes/auth.routes.ts) — authentication endpoints (login/register, etc.).
  - [src/routes/transactions.routes.ts](src/routes/transactions.routes.ts) — transactions endpoints (create/list transactions).

- Services:
  - [src/services/auth.service.ts](src/services/auth.service.ts) — authentication business logic.
  - [src/services/transaction.service.ts](src/services/transaction.service.ts) — transaction-related business logic.

- Middleware:
  - [src/middleware/session.ts](src/middleware/session.ts) — session handling configuration.
  - [src/middleware/rateLimit.ts](src/middleware/rateLimit.ts) — rate-limiting configuration.

- Types & Schemas:
  - [src/types/auth.types.ts](src/types/auth.types.ts)
  - [src/types/transaction.types.ts](src/types/transaction.types.ts)
  - [src/types/transaction.schema.ts](src/types/transaction.schema.ts)

- Tests:
  - [src/tests/test-suites/isolation.test.ts](src/tests/test-suites/isolation.test.ts)
  - [src/tests/test-suites/transactions.test.ts](src/tests/test-suites/transactions.test.ts)
  - [src/tests/test-suites/user.test.ts](src/tests/test-suites/user.test.ts)

This layout separates HTTP concerns (routes) from business logic (services), with shared utilities in `lib` and strong typing in `types`.

---

**Folder Structure (full tree)**

```
backend/
├─ generated/prisma/                # Prisma client + runtime artifacts
├─ prisma/
│  ├─ migrations/                   # migration history + SQL
│  └─ schema.prisma                 # Prisma schema
├─ lib/
│  └─ prisma.ts                     # Prisma client wrapper
├─ src/
│  ├─ index.ts                      # App entrypoint (server + routes)
│  ├─ lib/
│  │  └─ auth.ts                    # Auth helpers
│  ├─ middleware/
│  │  ├─ rateLimit.ts               # Rate limiting
│  │  └─ session.ts                 # Session handling
│  ├─ routes/
│  │  ├─ auth.routes.ts             # Auth endpoints
│  │  └─ transactions.routes.ts     # Transactions endpoints
│  ├─ services/
│  │  ├─ auth.service.ts            # Auth business logic
│  │  └─ transaction.service.ts     # Transaction business logic
│  └─ types/                        # Type definitions and request schemas
├─ tests/                            # Test helpers, mocks, and suites
│  ├─ mocks/
│  │  ├─ authMock.ts
│  │  └─ prismaMock.ts
│  └─ setup/
│     ├─ setup.ts
│     └─ test-app.ts
└─ coverage/                         # Generated coverage reports
```

**Request Flow Examples (how an input travels through the app)**

1) Auth — Login (example)

- Client HTTP request (POST /auth/login):

```json
{
  "email": "user@example.com",
  "password": "s3cret"
}
```

- Flow:
  1. Request arrives at the HTTP server configured in `src/index.ts`.
  2. Global middleware run: logging, `src/middleware/rateLimit.ts`, and `src/middleware/session.ts` validate/enrich the request.
  3. Router forwards to `src/routes/auth.routes.ts` (login route handler).
  4. Route handler validates payload (schema/type guards from `src/types/*`) then calls `src/services/auth.service.ts` (e.g., `authService.login()`).
  5. `auth.service` uses helpers in `src/lib/auth.ts` for password hashing/verification and calls the DB via the Prisma client in `lib/prisma.ts` (e.g., `prisma.user.findUnique()`).
  6. Prisma issues SQL to the database (configured by `DATABASE_URL` in `prisma/schema.prisma`).
  7. `auth.service` builds a session/token; route sets session cookie or returns token in response.
  8. Response returned to client (success or error).

- Key files involved: `src/index.ts` -> `src/middleware/session.ts` -> `src/routes/auth.routes.ts` -> `src/services/auth.service.ts` -> `src/lib/auth.ts` -> `lib/prisma.ts` -> `prisma/schema.prisma`.

2) Transactions — Create Transaction (example)

- Client HTTP request (POST /transactions):

```json
{
  "amount": 2500,
  "currency": "USD",
  "description": "Invoice #1234",
  "recipientId": "user_abc"
}
```

- Flow:
  1. Request hits `src/index.ts` and passes through auth/session middleware to ensure the user is authenticated.
  2. Rate limiter and payload validation run; route `src/routes/transactions.routes.ts` receives the request.
  3. Route calls `src/services/transaction.service.ts` (e.g., `transactionService.create()`), passing validated input and the authenticated user id.
  4. `transaction.service` applies business rules (balance checks, limits) and calls Prisma via `lib/prisma.ts` to persist the transaction (`prisma.transaction.create()`).
  5. On success, service may trigger side effects (notifications, event emitters) and returns the created transaction object to the route, which responds to the client.

- Key files involved: `src/index.ts` -> `src/middleware/session.ts` & `src/middleware/rateLimit.ts` -> `src/routes/transactions.routes.ts` -> `src/services/transaction.service.ts` -> `lib/prisma.ts`.

**Test flow (how tests isolate behavior)**

- Unit tests use mocks in `src/tests/mocks/prismaMock.ts` and `src/tests/mocks/authMock.ts` to stub `lib/prisma.ts` and `src/lib/auth.ts` behaviors so services and routes can be tested deterministically.
- Integration tests spin up the app via `src/tests/setup/test-app.ts`, which mirrors `src/index.ts` but can inject a test database or override `lib/prisma.ts` with a mock.

---

*** End Patch
---

**Coverage**

- Coverage output is available in `coverage/` with a browsable HTML report at `coverage/lcov-report/index.html`. If running `npm test` with coverage options, this will be regenerated.

---

**Development Tips & Common Tasks**

- Check `package.json` for the exact `scripts` (start, dev, test, build, coverage) before running commands.
- When changing Prisma models, run `npx prisma migrate dev --name <name>` and `npx prisma generate` to keep the generated client up-to-date.
- Use the mocks in `src/tests/mocks` to stub database calls during unit tests.

Debugging tests:

- Use `console.log` sparingly; prefer explicit Jest `--runInBand` if encountering race conditions.
- Run a single test file:

```bash
npm test -- src/tests/test-suites/transactions.test.ts
```

---

**Where to look next (entry points)**

- App bootstrap: [src/index.ts](src/index.ts)
- Database layer: [lib/prisma.ts](lib/prisma.ts)
- Auth flows: `src/routes/auth.routes.ts` -> `src/services/auth.service.ts` -> `src/lib/auth.ts`
- Transactions flows: `src/routes/transactions.routes.ts` -> `src/services/transaction.service.ts`

---

**Files of Interest**

- Prisma schema: [prisma/schema.prisma](prisma/schema.prisma)
- Generated client: [generated/prisma](generated/prisma)
- Migration SQL and history: [prisma/migrations](prisma/migrations)
- Tests and test setup files: [src/tests](src/tests)

---

**Contributing**

- Follow existing patterns: routes call services; services are pure business logic; tests use the setup files and mocks.
- Add unit tests for new services and integration tests for route behavior.

---

**Troubleshooting**

- If the server fails to start: check `DATABASE_URL`, run `npx prisma generate`, and ensure migrations are applied.
- If tests fail due to DB interactions: ensure tests use mocks or a test database; check `src/tests/setup/*` for guidance.

---

If you'd like, I can:

- Add concrete `npm` script examples to `package.json` (if you want me to edit it).
- Generate a `.env.example` with inferred env vars.
- Run tests and open the coverage report here.

Tell me which of the above you'd like next.
```
npm install
npm run dev
```

```
open http://localhost:3000
```
